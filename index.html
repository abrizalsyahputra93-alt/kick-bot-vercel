<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kick Bot Padang</title>
<script src="https://unpkg.com/crypto-js@4.2.0/crypto-js.js"></script>
<style>
/* sama seperti sebelumnya, bisa copy style lama */
</style>
</head>
<body>
<div class="card">
<h1>Kick Bot Padang</h1>
<p>Bot chat interaktif</p>

<div id="login">
  <button onclick="loginKick()">Login dengan Kick</button>
</div>

<div id="bot" style="display:none;">
  <input type="text" id="channel" placeholder="Masukkan channel">
  <input type="text" id="msgInput" placeholder="Ketik command">
  <button onclick="sendCommand()">Kirim Command</button>
  <div class="status" id="status">Siap...</div>
</div>

<div id="error" class="error" style="display:none;"></div>
</div>

<script>
const CLIENT_ID = '01K9SEDGKEAB4KH7WAJ8Q2XGVD';
const CLIENT_SECRET = '8fe491a2b6fe3949673e9228d824efb477a90de7425c8b8f8a564ecb039a2225';
const REDIRECT_URI = window.location.origin + window.location.pathname;
let token = null;
let verifier = null;

function generatePKCE(){
  verifier = CryptoJS.lib.WordArray.random(32).toString(CryptoJS.enc.Base64url);
  const challenge = CryptoJS.SHA256(verifier).toString(CryptoJS.enc.Base64url)
    .replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
  sessionStorage.setItem('pkce_verifier', verifier);
  return challenge;
}

function loginKick(){
  const challenge = generatePKCE();
  window.location.href = `https://kick.com/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code&scope=chat:read chat:write&code_challenge=${challenge}&code_challenge_method=S256&state=dummy`;
}

async function handleCallback(){
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if(code){
    try{
      const res = await fetch('/api/auth', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          code, client_id: CLIENT_ID, client_secret: CLIENT_SECRET, redirect_uri: REDIRECT_URI, verifier
        })
      });
      const data = await res.json();
      if(data.access_token){
        token = data.access_token;
        document.getElementById('login').style.display='none';
        document.getElementById('bot').style.display='block';
        document.getElementById('status').textContent='Login sukses!';
        history.replaceState({}, '', REDIRECT_URI);
      } else showError('Gagal login');
    } catch(e){ showError(e.message); }
  }
}

async function sendCommand(){
  const channel = document.getElementById('channel').value.trim();
  const msg = document.getElementById('msgInput').value.trim();
  if(!channel || !msg) return showError('Channel & command harus diisi!');
  try{
    const res = await fetch('/api/send',{
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ channel, message: msg, token })
    });
    const data = await res.json();
    if(data.success) document.getElementById('status').textContent=`Terkirim: ${msg}`;
    else showError(data.error || 'Gagal kirim pesan');
  } catch(e){ showError(e.message); }
}

function showError(msg){
  const e = document.getElementById('error');
  e.textContent = msg; e.style.display='block';
  setTimeout(()=>{e.style.display='none'},4000);
}

window.addEventListener('load', handleCallback);
</script>
</body>
</html>
